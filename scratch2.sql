with map_subset as (SELECT * FROM smart_columbus_cve__captcha where os_partition = '2020_12' and sourcedevice = 'morse_sunbury_cvcp' and messagetype = 'MAP' and timestamp > '2020-12-09T07:00:00.000Z' and timestamp < '2020-12-09T07:05:00.000Z' limit 1),
extracted_values as (
    select json_extract(messageBody, '$.intersections[0].laneSet[0]') as cursor, 
           json_extract(messageBody, '$.intersections[0].laneWidth') as laneWidth, 
           cast(json_extract_scalar(messageBody, '$.intersections[0].refPoint.lat') as double) as refLat, 
           cast(json_extract_scalar(messageBody, '$.intersections[0].refPoint.long') as double) as refLon, 

           transform(
               cast(json_extract(messageBody, '$.intersections[0].laneSet') AS ARRAY<JSON>), 
                 x -> JSON_EXTRACT(x, '$.nodeList[1][0].delta[1]')
            ) as deltas,
            * from map_subset),
extracted_deltas as (select cast(transform(deltas, x -> CAST(ROW(JSON_EXTRACT(x,'$.x'), JSON_EXTRACT(x,'$.y')) AS ROW(x DOUBLE, y DOUBLE))) as ARRAY<ROW(x DOUBLE, y DOUBLE)>) as row_deltas, * from extracted_values),
extracted_coordinates as (select transform(row_deltas, x -> cast(ROW(refLat - x.x, refLon - x.y) as ROW(lat DOUBLE, lon DOUBLE))) as coordinates, * from extracted_deltas)
SELECT lat / 10000000, lon / 10000000 FROM extracted_coordinates CROSS JOIN UNNEST(coordinates) AS t (lat, lon)




extracted_deltas as (select cast(transform(deltas, x -> CAST(ROW(JSON_EXTRACT(x,'$.x'), JSON_EXTRACT(x,'$.y')) AS ROW(x DOUBLE, y DOUBLE))) as ARRAY<ROW(x DOUBLE, y DOUBLE)>) as row_deltas, * from extracted_values),
extracted_coordinates as (select transform(row_deltas, x -> cast(ROW(refLat - x.x, refLon - x.y) as ROW(lat DOUBLE, lon DOUBLE))) as coordinates, * from extracted_deltas)
SELECT lat / 10000000, lon / 10000000 FROM extracted_coordinates CROSS JOIN UNNEST(coordinates) AS t (lat, lon)