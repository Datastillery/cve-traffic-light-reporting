# CVE Reporting

This repo contains the notebooks and working files for the Smart Columbus Connected Vehicle Environment reporting effort

## Running locally

### Requirements:
+ Python (https://www.python.org/downloads/)
+ Poetry (https://python-poetry.org/docs/#installation)

```poetry install```

```poetry run jupyter notebook```

> Note: Most of the notebooks and reports in this repo assume that you have direct access to the Presto database behind the OS. This is accomplished by port-forwarding the coordinator. See the k8s docs for more information or use k9s' shortcuts.

## Running remotely

> These steps have not been rigorously tested in all situations

```sh
# Create the deployment
kubectl create deployment --image=python:3.9.1-buster cve-reporter

# Find the pod name
kubectl get pods

# Copy the app code to the pod
kubectl cp app/*.py default/cve-reporter-745f5db67d-p6r8v:/app

# Exec into pod
kubectl exec -it cve-reporter-745f5db67d-p6r8v -- bin/bash

# Install poetry
pip install --user poetry

# Install dependencies
poetry install

# Get into the poetry shell
poetry shell

# Run whatever report is necessary
python rlr_report.py
```

Logs from the reports will be found in a file called `cve.log`. If connection to the pod is lost, the process will continue running and its progress can be checked by reconnecting and checking the log file. The current query can be seen in the presto console.

Reports will create a table per partition they run against. These tables can be unioned into a new table or inserted into a master table. The output of each report can either be inserted directly into a dataset's table, or downloaded via Python and ingested as a static file.

## Reports
Each report is composed of a Jupyter notebook that chronicles its development, and a Python script that represents the runnable report. 

***The queries in the notebook may not be the final version of the SQL used to generate the report. The Python scripts should be considered the "production" version.***

### Red Light Runs
This report tracks BSMs crossing stop bars. The end result is a single record per vehicle that crossed a given stop bar, with the location being the closest it came to the stop bar itself. This data can be used to track red light runs, but it primarily generated to support the Warning Effectiveness report.

```
app/rlr_report.py
notebooks/Red Light Runs.ipynb
```

### Warning Issuance
This report simulates the issuance of Red Light Violation Warnings (RLVWs). Using a complex algorithm provided by the engineers behind the system, this series of queries determines whether any given BSM should have received a warning or not, along with its state at that time. Because it deals with almost all BSMs in the dataset, this report is *extremely* slow. A single day's data can take 1.5 to 2 hours to process.

```
app/warning_issuance.py
notebooks/Warning Issuance.ipynb
```

### Warning Effectiveness
This query combines data from the Red Light Run and Warning Issuance reports to determine the effectiveness of the RLVWs. This query is very fast, as it only joins two small tables.

```
app/warning_effectiveness_report.py
notebooks/Warning Effectiveness.ipynb
```

### Signal Preemption
Taking all the Signal Request (SRM) and Signal Status (SSM) messages from the dataset, this report tracks the status of Signal Preemption requests with their final status, intersection, and vehicle role.

```
app/preemption_report.py
notebooks/Signal Preemption.ipynb
```

### Idle Time
In support of the Signal Preemption report, this query and report tracks the time vehicles spend idling or slow (as defined in the query). As BSMs are sent at strict 100ms intervals, the number presented in the report represents that x number of 100ms intervals were spent in a given state. While this report is primarily concerned with traffic within a specific corridor, all intersections are used. **This query, while faster than Warning Issuance, is very slow.**

```
app/idle_time_report.py
notebooks/Idle Time.ipynb
```

### Time at Intersection
Part of an effort to track the amount of time Emergency vehicles spend in intersections, this report tracks the time all kinds of vehicles spend in them. The type of vehicle can be determined by cross referencing this dataset with the Signal Preemption report. This report, when these docs were written, experiences issues with re-used vehicle ids. When reporting on this data, it is recommended to filter out times greater than 300 seconds (5 minutes) as this is the maximum time a vehicle can have a given id.

```
app/time_at_intersection_report.py
notebooks/Time At Intersection.ipynb
```

### School Zone Speed Warnings
TBD

```
TBD
```